#!/bin/sh -xeu

create_rpm_repo() {
 reponame=$1
 url=$2

 repofile="/etc/yum.repos.d/$reponame.repo"
 cat > $repofile <<EOF
[$reponame]
name=$reponame
baseurl=$url
enabled=1
proxy=_none_
gpgcheck=0
EOF
}

install_pkgs() {
 cmd=$1
 testreq_pkgs=$2
 pkgs=$3

 if [ -n "$testreq_pkgs" ]; then
   echo "======= Installing TEST REQ packages ========"
   $cmd $testreq_pkgs
 fi
 if [ -n "$pkgs" ]; then
   echo "======= Installing UNDER TEST packages ========"
   $cmd $pkgs
 fi
}

project="$1"
repo="$2"
packages="$3"
sproject="$4"
testreq_packages="$5"

if [ -x /usr/bin/apt-get -a -d /etc/apt/sources.list.d/ ] ; then
# Ubuntu
   srclist="/etc/apt/sources.list.d/Tools.list"
   [ -n "$project" ] && echo "deb http://download.otctools.jf.intel.com/home:/tester:/$project/$repo/ /" >  $srclist
   [ -n "$sproject" ] && echo "deb http://download.otctools.jf.intel.com/$sproject/$repo/ /" >> $srclist
   apt-get update
   apt-get upgrade -y --force-yes
   install_pkgs "apt-get install -y --force-yes" "$testreq_packages" "$packages"
elif [ -x /usr/bin/zypper -a -d /etc/zypp/repos.d ] ; then
# OpenSuse
   [ -n "$project" ] && zypper ar -fG http://download.otctools.jf.intel.com/home:/tester:/$project/$repo/ $project
   reponame="tools-`echo \"$sproject\" | tr -d '[:punct:][:space:]'`"
   [ -n "$sproject" ] && zypper ar -fG http://download.otctools.jf.intel.com/$sproject/$repo/ $reponame
   zypper --non-interactive ref
   zypper --non-interactive up
   install_pkgs "zypper --non-interactive install" "$testreq_packages" "$packages"
elif [ \( -x /bin/yum -o -x /usr/bin/yum \) -a -d /etc/yum.repos.d ] ; then
# Fedora
   srclist="/etc/yum.repos.d/otctools.repo"
   url="http://download.otctools.jf.intel.com/home:/tester:/$project/$repo/"
   [ -n "$project" ] && create_rpm_repo $project $url
   url="http://download.otctools.jf.intel.com/$sproject/$repo/"
   [ -n "$sproject" ] && create_rpm_repo "tools" $url
   yum -y clean all
   yum -y update
   install_pkgs "yum -y install" "$testreq_packages" "$packages"
fi
