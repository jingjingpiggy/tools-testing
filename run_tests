#!/bin/sh -efu

src="$1"
reports_dir="$2"

cd $src

# Run pylint
mkdir -p ~/.pylint.d/
rm -f pylint.log
cdir=`pwd`
for path in `find $cdir -name \*.py`; do
    fdir=`dirname $path`
    fname=`basename $path`
    [ "$fdir" = "$cdir" ] && rname=$fname || rname=`echo $fdir|sed "s|$cdir/\(.*\)|\1/$fname|"`
    cd $fdir
    pylint --output-format=parseable --reports=n $fname |sed "s|[^:]\+:\([0-9]\+\): \(.*\)|$rname:\1: \2|g" >> $cdir/pylint.log
done || :
cd $cdir

if [ -d tests ] ; then
    # Run nosetests with coverage support
    nosetests -v --with-coverage --with-xunit

    # Run coverage
    coverage=$(which coverage || which python-coverage)
    $coverage xml
fi

# Move reports
for fn in pylint.log nosetests.xml coverage.xml ; do
    [ -f "$fn" ] && mv $fn $reports_dir
done

echo 'Done'
