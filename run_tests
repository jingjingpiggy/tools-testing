#!/bin/sh -efu

src="$1"
reports_dir="$2"

cd $src

# Run pylint
mkdir -p ~/.pylint.d/
rm -f pylint.log
for path in `find . -name \*.py`; do
    pylint --output-format=parseable --reports=y $path >> pylint.log
done || :

if [ -d tests ] ; then
    # Run nosetests with coverage support
    nosetests -v --with-coverage --with-xunit

    # Run coverage
    coverage=$(which coverage || which python-coverage)
    $coverage xml
fi

# Move reports
for fn in pylint.log nosetests.xml coverage.xml ; do
    [ -f "$fn" ] && mv $fn $reports_dir
done

echo 'Done'
